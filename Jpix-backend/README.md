# Jpix ‚Äî Informe 2 (EP 2.1)

**Objetivo del hito:** levantar el backend base con **Node.js + Express**, listo para crecer en EP 2.2‚Äì2.6 sin reordenar nada.  
Incluye middlewares, versionado de API y un **healthcheck**.

## üì¶ Estructura del repo (monorepo)
```
JPIX-PROYECTO/
‚îú‚îÄ Jpix/           # Frontend (Ionic + Angular)
‚îî‚îÄ jpix-backend/   # Backend (Node + Express)  ‚Üê este README
```
---

## ‚úÖ Requisitos
- Node.js 18+ y npm
- (Opcional) Postman/Insomnia para probar la API

---

## üîß Instalaci√≥n (s√≥lo primera vez)
```bash
cd jpix-backend
npm init -y
npm i express cors morgan
npm i -D nodemon
```

Crear `.env.example`:
```
PORT=3000
```
(Para correr localmente puedes copiarlo a `.env`).

---

## üìÅ Archivos creados (m√≠nimos EP 2.1)

```
jpix-backend/
‚îî‚îÄ src/
   ‚îú‚îÄ server.js
   ‚îú‚îÄ app.js
   ‚îú‚îÄ config/
   ‚îÇ   ‚îî‚îÄ env.js
   ‚îú‚îÄ middlewares/
   ‚îÇ   ‚îî‚îÄ error.middleware.js
   ‚îî‚îÄ routes/
       ‚îî‚îÄ v1/
           ‚îî‚îÄ health.routes.js
```

**src/server.js**
```js
const { app } = require('./app');
const { PORT } = require('./config/env');

app.listen(PORT, () => {
  console.log(`Jpix API escuchando en http://localhost:${PORT}`);
});
```

**src/app.js**
```js
const express = require('express');
const cors = require('cors');
const morgan = require('morgan');

const { errorHandler } = require('./middlewares/error.middleware');
const healthRoutes = require('./routes/v1/health.routes');

const app = express();
app.use(cors());
app.use(express.json());
app.use(morgan('dev'));

app.use('/api/v1/health', healthRoutes);

// opcional: evitar 404 por favicon
app.get('/favicon.ico', (_req, res) => res.status(204).end());

app.use(errorHandler); // siempre al final

module.exports = { app };
```

**src/config/env.js**
```js
require('dotenv').config();
exports.PORT = process.env.PORT || 3000;
```

**src/middlewares/error.middleware.js**
```js
exports.errorHandler = (err, _req, res, _next) => {
  console.error(err);
  const status = err.status || 500;
  res.status(status).json({
    error: { message: err.message || 'Error interno', code: status }
  });
};
```

**src/routes/v1/health.routes.js**
```js
const router = require('express').Router();
router.get('/', (_req, res) => res.status(200).json({ status: 'ok' }));
module.exports = router;
```

---

## üèÉ‚Äç‚ôÄÔ∏è Scripts de ejecuci√≥n
Agregados en `package.json`:
```json
{
  "scripts": {
    "start": "node src/server.js",
    "dev": "nodemon src/server.js"
  }
}
```

### Correr en desarrollo
```bash
npm run dev
```
La API queda en: `http://localhost:3000`

---

## ‚úÖ Verificaci√≥n (healthcheck)
Probar en navegador o Postman:
```
GET http://localhost:3000/api/v1/health
```
**Respuesta esperada:**
```json
{ "status": "ok" }
```

---

## üìê Convenciones que quedan fijas (para no reescribir despu√©s)
- **Prefijo de API:** `/api/v1/*`
- **Middlewares globales:** `express.json()`, `cors()`, logger (`morgan`) y `errorHandler`
- **Formato recomendado de respuestas:**
  - OK ‚Üí `{ "data": ... }`
  - Error ‚Üí `{ "error": { "message": "...", "code": 400|401|... } }`
- **C√≥digos de estado:** 200/201/204 (OK/creado/borrado), 400, 401, 403, 404, 500

---

## üß© Pr√≥ximos pasos (no implementados a√∫n)
- **EP 2.2 ‚Äî BD relacional:** crear `config/db.js` (pool con `pg` o `mysql2`), modelos SQL y seeds.
- **EP 2.3 ‚Äî Endpoints b√°sicos:** `routes/controllers/services/repositories` para `/courses` (GET/POST/PUT/DELETE).
- **EP 2.4 ‚Äî Integraci√≥n con Ionic:** `environment.API_URL` en front y uso de `HttpClient` contra `http://localhost:3000/api/v1/...`
- **EP 2.5/2.6 ‚Äî Autenticaci√≥n JWT:** rutas `/auth` (login/register), `bcrypt`, `jsonwebtoken` y `auth.middleware`.

---

## üß∞ Troubleshooting
- **`Cannot find module './app'`**  
  Aseg√∫rate de que `src/app.js` exporte `module.exports = { app }` y que `server.js` importe `const { app } = require('./app')`.
- **CORS bloqueado desde Ionic**  
  Confirmar `app.use(cors())` en `app.js`.
- **El puerto ya est√° en uso**  
  Cambia `PORT` en `.env`.

---

## üìù Commit sugerido
```bash
git add .
git commit -m "feat(backend): base Express con /api/v1/health, CORS y error handler (EP 2.1)"
git push
```
Opcional:
```bash
git tag ep-2.1
git push --tags
```

# Jpix ‚Äî Informe 2 (EP 2.2)

**Objetivo del hito:**  
Configurar la **base de datos relacional con PostgreSQL** e integrarla al backend Express mediante **Sequelize ORM**.  
Incluye conexi√≥n mediante `.env`, creaci√≥n de usuario/base local, migraciones y seeders.

---

## üì¶ Estructura del repo (monorepo)

```
JPIX-PROYECTO/
‚îú‚îÄ Jpix/                # Frontend (Ionic + Angular)
‚îî‚îÄ jpix-backend/        # Backend (Node + Express + PostgreSQL)
```

---

## ‚úÖ Requisitos

- Node.js 18+ y npm  
- PostgreSQL 14 o superior (idealmente v18)  
- pgAdmin 4 (opcional, para administrar la base visualmente)  
- (Opcional) Postman o Insomnia para probar la API  

---

## üß± Instalaci√≥n y configuraci√≥n de PostgreSQL (solo primera vez)

1. **Descargar PostgreSQL** desde  
   üëâ [https://www.postgresql.org/download/](https://www.postgresql.org/download/)

2. **Instalar** dejando las opciones por defecto:
   - Usuario administrador: `postgres`
   - Contrase√±a: (elige una y recu√©rdala)
   - Puerto: `5432`
   - Incluye **pgAdmin 4**

3. **Crear usuario y base de datos del proyecto**  
   Abrir `psql` o el panel de consultas de pgAdmin y ejecutar:

   ```sql
   CREATE ROLE jpix_user WITH LOGIN PASSWORD 'admin123';
   ALTER ROLE jpix_user CREATEDB;
   CREATE DATABASE jpix_db OWNER jpix_user;
   GRANT ALL PRIVILEGES ON DATABASE jpix_db TO jpix_user;
   ```

**üìå Datos de conexi√≥n**

| Campo | Valor |
|-------|--------|
| Usuario | `jpix_user` |
| Contrase√±a | `admin123` |
| Base de datos | `jpix_db` |
| Puerto | `5432` |

---

## ‚öôÔ∏è Configuraci√≥n del entorno (.env)

Cada integrante debe tener su propio archivo `.env` dentro de `jpix-backend/`:

```bash
NODE_ENV=development
PORT=3000

DB_HOST=127.0.0.1
DB_PORT=5432
DB_USER=jpix_user
DB_PASS=admin123
DB_NAME=jpix_db
DB_DIALECT=postgres
```

‚ö†Ô∏è El `.env` **no se sube** al repositorio.  
Solo se sube `.env.example` sin la contrase√±a real.

---

## üß© Configuraci√≥n de Sequelize

**config/config.js**
```js
require('dotenv').config();

module.exports = {
  development: {
    username: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASS || '',
    database: process.env.DB_NAME || 'jpix_db',
    host: process.env.DB_HOST || '127.0.0.1',
    port: process.env.DB_PORT || 5432,
    dialect: process.env.DB_DIALECT || 'postgres'
  },
  test: {
    username: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASS || '',
    database: process.env.DB_NAME_TEST || 'jpix_db_test',
    host: process.env.DB_HOST || '127.0.0.1',
    port: process.env.DB_PORT || 5432,
    dialect: process.env.DB_DIALECT || 'postgres'
  },
  production: {
    username: process.env.DB_USER,
    password: process.env.DB_PASS,
    database: process.env.DB_NAME,
    host: process.env.DB_HOST,
    port: process.env.DB_PORT,
    dialect: process.env.DB_DIALECT
  }
};
```

**.sequelizerc**
```js
const path = require('path');

module.exports = {
  'config': path.resolve('config', 'config.js'),
  'models-path': path.resolve('src', 'models'),
  'seeders-path': path.resolve('src', 'seeders'),
  'migrations-path': path.resolve('src', 'migrations')
};
```

---

## üì¶ Instalaci√≥n de dependencias

```bash
cd jpix-backend
npm install
npm install sequelize pg pg-hstore
npm install --save-dev sequelize-cli dotenv
```

---

## üß† Crear base y verificar conexi√≥n

```bash
npx sequelize-cli db:create
```

**Posibles mensajes:**  
‚úÖ `Database jpix_db created.` ‚Üí conexi√≥n correcta.  
‚ö†Ô∏è `la base de datos ¬´jpix_db¬ª ya existe` ‚Üí tambi√©n correcto.

---

## üß± Migraciones (estructura de tablas)

**Crear migraci√≥n**
```bash
npx sequelize-cli migration:generate --name create-usuarios
```

**Ejemplo (`src/migrations/XXXX-create-usuarios.js`)**
```js
'use strict';
module.exports = {
  async up(queryInterface, Sequelize) {
    await queryInterface.createTable('usuarios', {
      id: { allowNull: false, autoIncrement: true, primaryKey: true, type: Sequelize.INTEGER },
      nombre: { type: Sequelize.STRING, allowNull: false },
      email: { type: Sequelize.STRING, allowNull: false, unique: true },
      rol: { type: Sequelize.ENUM('admin', 'estudiante'), defaultValue: 'estudiante' },
      createdAt: { allowNull: false, type: Sequelize.DATE, defaultValue: Sequelize.literal('CURRENT_TIMESTAMP') },
      updatedAt: { allowNull: false, type: Sequelize.DATE, defaultValue: Sequelize.literal('CURRENT_TIMESTAMP') }
    });
  },
  async down(queryInterface) {
    await queryInterface.dropTable('usuarios');
  }
};
```

**Aplicar migraciones**
```bash
npx sequelize-cli db:migrate
```

---

## üå± Seeders (datos de ejemplo)

**Crear seeder**
```bash
npx sequelize-cli seed:generate --name demo-usuarios
```

**Ejemplo (`src/seeders/XXXX-demo-usuarios.js`)**
```js
'use strict';
module.exports = {
  async up(queryInterface) {
    await queryInterface.bulkInsert('usuarios', [
      { nombre: 'Administrador', email: 'admin@jpix.cl', rol: 'admin', createdAt: new Date(), updatedAt: new Date() },
      { nombre: 'Estudiante Prueba', email: 'estudiante@jpix.cl', rol: 'estudiante', createdAt: new Date(), updatedAt: new Date() }
    ]);
  },
  async down(queryInterface) {
    await queryInterface.bulkDelete('usuarios', null, {});
  }
};
```

**Ejecutar seeders**
```bash
npx sequelize-cli db:seed:all
```

---

## üß∞ Comandos √∫tiles

| Acci√≥n | Comando |
|--------|----------|
| Crear base | `npx sequelize-cli db:create` |
| Ejecutar migraciones | `npx sequelize-cli db:migrate` |
| Insertar datos iniciales | `npx sequelize-cli db:seed:all` |
| Revertir √∫ltima migraci√≥n | `npx sequelize-cli db:migrate:undo` |
| Borrar todos los datos de seeders | `npx sequelize-cli db:seed:undo:all` |

---

## üß† Errores comunes

| Mensaje | Causa | Soluci√≥n |
|----------|--------|----------|
| `ECONNREFUSED 127.0.0.1:5432` | PostgreSQL no est√° encendido | Iniciar el servicio desde `services.msc` |
| `password authentication failed` | Contrase√±a incorrecta | Verificar `.env` y usuario de PostgreSQL |
| `client password must be a string` | `DB_PASS` vac√≠o o mal definido | Revisar `.env` |
| `database jpix_db already exists` | Base ya creada | No es error, continuar con migraciones |
| `relation "usuarios" does not exist` | No se aplicaron migraciones | Ejecutar `db:migrate` |

---

## üë• Instrucciones para cada integrante del grupo

1. Instalar PostgreSQL localmente.  
2. Crear usuario y base (`jpix_user`, `jpix_db`).  
3. Crear archivo `.env` (copiar de `.env.example` y completar).  
4. Ejecutar los siguientes comandos:

```bash
npm install
npx sequelize-cli db:create
npx sequelize-cli db:migrate
npx sequelize-cli db:seed:all
npm run dev
```

**Probar API en Postman:**
```bash
GET http://localhost:3000/api/v1/usuarios
```

---

## üìù Commit sugerido

```bash
git add .
git commit -m "feat(backend): configuraci√≥n PostgreSQL + Sequelize con migraciones y seeders (EP 2.2)"
git push
```

**Opcional:**

```bash
git tag ep-2.2
git push --tags
```

---

## üèÅ Resultado final esperado

‚úÖ Base de datos `jpix_db` creada localmente en cada PC  
‚úÖ Usuario `jpix_user` con permisos  
‚úÖ Conexi√≥n PostgreSQL + Sequelize funcionando  
‚úÖ Migraciones y seeders aplicados  
‚úÖ Listo para avanzar al **EP 2.3 (endpoints CRUD)**

# üì¶ Estructura del Monorepo ‚Äî JPIX

```
JPIX-PROYECTO/
‚îú‚îÄ Jpix/                 # Frontend (Ionic + Angular)
‚îî‚îÄ jpix-backend/         # Backend (Node + Express + PostgreSQL)
   ‚îú‚îÄ .sequelizerc
   ‚îú‚îÄ config/
   ‚îÇ  ‚îî‚îÄ config.js
   ‚îú‚îÄ data/              # CSVs limpios (pegarlos aqu√≠)
   ‚îÇ  ‚îú‚îÄ asignaturas_obligatorias_limpias.csv
   ‚îÇ  ‚îú‚îÄ asignaturas_fofu_limpias.csv
   ‚îÇ  ‚îú‚îÄ secciones.csv
   ‚îÇ  ‚îú‚îÄ secciones_fofu.csv
   ‚îÇ  ‚îú‚îÄ bloques_horario.csv
   ‚îÇ  ‚îú‚îÄ bloques_horario_fofu.csv
   ‚îÇ  ‚îî‚îÄ prerequisitos_obligatorias.csv
   ‚îú‚îÄ src/
   ‚îÇ  ‚îú‚îÄ server.js
   ‚îÇ  ‚îú‚îÄ app.js
   ‚îÇ  ‚îú‚îÄ config/
   ‚îÇ  ‚îÇ  ‚îî‚îÄ env.js
   ‚îÇ  ‚îú‚îÄ middlewares/
   ‚îÇ  ‚îÇ  ‚îî‚îÄ error.middleware.js
   ‚îÇ  ‚îú‚îÄ models/
   ‚îÇ  ‚îÇ  ‚îú‚îÄ index.js              # loader a prueba de balas (factory functions)
   ‚îÇ  ‚îÇ  ‚îú‚îÄ usuario.js
   ‚îÇ  ‚îÇ  ‚îú‚îÄ asignatura.js
   ‚îÇ  ‚îÇ  ‚îú‚îÄ seccion.js
   ‚îÇ  ‚îÇ  ‚îú‚îÄ bloquehorario.js
   ‚îÇ  ‚îÇ  ‚îî‚îÄ requisito.js
   ‚îÇ  ‚îú‚îÄ migrations/
   ‚îÇ  ‚îÇ  ‚îú‚îÄ ... (usuarios si ya exist√≠a)
   ‚îÇ  ‚îÇ  ‚îî‚îÄ 20251013-init-schema.js
   ‚îÇ  ‚îú‚îÄ seeders/
   ‚îÇ  ‚îÇ  ‚îú‚îÄ 20251010013742-demo-usuarios.js
   ‚îÇ  ‚îÇ  ‚îú‚îÄ 20251013-01-seed-asignaturas.js
   ‚îÇ  ‚îÇ  ‚îú‚îÄ 20251013-02-seed-secciones.js
   ‚îÇ  ‚îÇ  ‚îú‚îÄ 20251013-03-seed-bloques.js
   ‚îÇ  ‚îÇ  ‚îî‚îÄ 20251013-04-seed-requisitos.js
   ‚îÇ  ‚îî‚îÄ routes/
   ‚îÇ     ‚îî‚îÄ v1/
   ‚îÇ        ‚îú‚îÄ health.routes.js
   ‚îÇ        ‚îú‚îÄ users.routes.js
   ‚îÇ        ‚îî‚îÄ asignaturas.routes.js   # (opcional pero recomendado)
   ‚îî‚îÄ package.json
```

## ‚úÖ Requisitos
- Node.js 18+ y npm
- PostgreSQL corriendo en local (puerto 5432 por defecto)
- (Opcional) Postman o curl

## üîß Instalaci√≥n r√°pida
```bash
cd jpix-backend
npm i
npm i express cors morgan
npm i sequelize pg pg-hstore
npm i -D sequelize-cli dotenv nodemon
npm i bcryptjs csv-parse
```

## ‚öôÔ∏è PostgreSQL (una vez)
```sql
CREATE ROLE jpix_user WITH LOGIN PASSWORD 'admin123';
ALTER ROLE jpix_user CREATEDB;
CREATE DATABASE jpix_db OWNER jpix_user;
GRANT ALL PRIVILEGES ON DATABASE jpix_db TO jpix_user;
```

## üîê .env en jpix-backend/
```bash
NODE_ENV=development
PORT=3000

DB_HOST=127.0.0.1
DB_PORT=5432
DB_USER=jpix_user
DB_PASS=admin123
DB_NAME=jpix_db
DB_DIALECT=postgres
# DB_SSL=true    # solo si tu proveedor prod lo pide
```

No comitear .env. Dejar un .env.example sin secretos.

## üß≠ Configuraci√≥n Sequelize
**.sequelizerc**
```js
const path = require('path');

module.exports = {
  'config': path.resolve('config', 'config.js'),
  'models-path': path.resolve('src', 'models'),
  'seeders-path': path.resolve('src', 'seeders'),
  'migrations-path': path.resolve('src', 'migrations')
};
```

**config/config.js**
```js
require('dotenv').config();

module.exports = {
  development: {
    username: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASS || '',
    database: process.env.DB_NAME || 'jpix_db',
    host: process.env.DB_HOST || '127.0.0.1',
    port: process.env.DB_PORT || 5432,
    dialect: process.env.DB_DIALECT || 'postgres',
    logging: false
  },
  test: {
    username: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASS || '',
    database: process.env.DB_NAME_TEST || 'jpix_db_test',
    host: process.env.DB_HOST || '127.0.0.1',
    port: process.env.DB_PORT || 5432,
    dialect: process.env.DB_DIALECT || 'postgres',
    logging: false
  },
  production: {
    username: process.env.DB_USER,
    password: process.env.DB_PASS,
    database: process.env.DB_NAME,
    host: process.env.DB_HOST,
    port: process.env.DB_PORT,
    dialect: process.env.DB_DIALECT,
    logging: false,
    dialectOptions: process.env.DB_SSL === 'true' ? {
      ssl: { require: true, rejectUnauthorized: false }
    } : {}
  }
};
```

## üß† Modelos (Sequelize)
Usuario ‚Üí tabla usuarios (campos: rut, nombre, email √∫nico, password_hash, rol ENUM)
Asignatura ‚Üí asignaturas (obligatorias/fofu/etc.)
Seccion ‚Üí secciones (FK a asignaturas)
BloqueHorario ‚Üí bloques_horario (FK a secciones)
Requisito ‚Üí requisitos (self-join de asignaturas)
El loader src/models/index.js ignora archivos que no sean factory function, evitando crashes.

## üß± Migraciones
Tu migraci√≥n de usuarios (ya existente).
Nueva migraci√≥n acad√©mica: 20251013-init-schema.js
Crea asignaturas, secciones, bloques_horario, requisitos.
√çndices y constraints (FKs, uniques).
Usa ENUMs para tipo, semestralidad, dia, actividad, paridad.

Si alguna vez tienes conflictos por tipos ENUM al hacer rollback/re-run, la migraci√≥n down intenta dropear esos tipos. Si persiste, te paso versi√≥n con STRING.

## üå± Seeders
20251010013742-demo-usuarios.js
Inserta dos usuarios demo con bcryptjs ‚Üí respeta rut y password_hash NOT NULL.
20251013-01-seed-asignaturas.js ‚Üí Lee CSV asignaturas_obligatorias_limpias.csv y asignaturas_fofu_limpias.csv.
20251013-02-seed-secciones.js ‚Üí Lee secciones.csv y secciones_fofu.csv y enlaza por sigla.
20251013-03-seed-bloques.js ‚Üí Lee bloques_horario.csv y bloques_horario_fofu.csv y enlaza por (sigla,seccion).
20251013-04-seed-requisitos.js ‚Üí Lee prerequisitos_obligatorias.csv y enlaza por sigla.

CSV esperados (en jpix-backend/data/):
asignaturas_obligatorias_limpias.csv, asignaturas_fofu_limpias.csv,
secciones.csv, secciones_fofu.csv,
bloques_horario.csv, bloques_horario_fofu.csv,
prerequisitos_obligatorias.csv.

## üõ£Ô∏è Rutas Express
Health
GET /api/v1/health ‚Üí { "status": "ok" }

Usuarios (src/routes/v1/users.routes.js + src/controllers/users.controller.js)
GET /api/v1/usuarios
GET /api/v1/usuarios/:id
POST /api/v1/usuarios
PUT /api/v1/usuarios/:id
DELETE /api/v1/usuarios/:id

Asignaturas (opcional pero incluido)
GET /api/v1/asignaturas
GET /api/v1/asignaturas/:sigla (incluye secciones y bloques)

## üèÉ Scripts en package.json
```json
{
  "scripts": {
    "start": "node src/server.js",
    "dev": "nodemon src/server.js",
    "db:create": "sequelize-cli db:create",
    "db:migrate": "sequelize-cli db:migrate",
    "db:seed": "sequelize-cli db:seed:all",
    "db:reset": "sequelize-cli db:seed:undo:all && sequelize-cli db:migrate:undo:all && sequelize-cli db:migrate && sequelize-cli db:seed:all"
  }
}
```

## üöÄ C√≥mo correr todo
CSV: pega los 7 CSV en jpix-backend/data/
DB:
```bash
npm run db:create
npm run db:migrate
npm run db:seed
```
Servidor:
```bash
npm run dev
```
Deber√≠as ver: Jpix API escuchando en http://localhost:3000

## üß™ Smoke tests (curl)
```bash
curl http://localhost:3000/api/v1/health
curl http://localhost:3000/api/v1/usuarios
curl http://localhost:3000/api/v1/usuarios/1
curl -X POST http://localhost:3000/api/v1/usuarios -H "Content-Type: application/json" -d '{"rut":"12345678-9","nombre":"Nuevo","email":"nuevo@jpix.cl","password":"secreto","rol":"estudiante"}'
curl http://localhost:3000/api/v1/asignaturas
curl http://localhost:3000/api/v1/asignaturas/INFXXXX
```

## üß∞ Troubleshooting (errores reales que vimos)
404 GET /api/v1/healt ‚Üí Typo: es /api/v1/health.
el valor nulo en la columna rut/password_hash ‚Üí Usa bcryptjs y rut en seeder.
Class constructor model cannot be invoked without 'new' ‚Üí Loader seguro en models/index.js.
app.use() requires a middleware function ‚Üí Revisa exports de routers.
ENUM rollback ‚Üí Si persiste error, cambia ENUM a STRING.

## üß≠ Decisiones de dise√±o
CSV ‚Üí Seeders: cargamos datos limpios directo a PostgreSQL.
Migraciones acad√©micas separadas.
FKs con ON DELETE CASCADE.
Prerrequisitos: self-join.
Rutas CRUD + asignaturas consulta r√°pida.

## ‚ñ∂Ô∏è Pr√≥ximos pasos (EP 2.3+)
CRUD completo /asignaturas, /secciones, /bloques.
Tabla docentes + FK en secciones.
Endpoint /horarios/propuesta (sin choques).
Autenticaci√≥n JWT (roles).
Tests Jest/Supertest.

# JPIX ‚Äî EP 2.3 ¬∑ API REST b√°sica (Backend listo y probado)

Este README resume **lo implementado y probado en el Punto 2.3** del proyecto **Jpix**: API REST con **Express + Sequelize + PostgreSQL**, modelos, migraciones, seeders, rutas y pruebas con **Insomnia**.

> **Tip:** Este backend queda preparado para continuar con **EP 2.4** (consumo desde Ionic con `HttpClient`) sin reordenar nada.

---

## üì¶ Estructura del repo (monorepo)

```
JPIX-PROYECTO/
‚îú‚îÄ Jpix/                 # Frontend (Ionic + Angular)
‚îî‚îÄ jpix-backend/         # Backend (Node + Express + PostgreSQL)
   ‚îú‚îÄ .sequelizerc
   ‚îú‚îÄ config/
   ‚îÇ  ‚îî‚îÄ config.js
   ‚îú‚îÄ src/
   ‚îÇ  ‚îú‚îÄ server.js
   ‚îÇ  ‚îú‚îÄ app.js
   ‚îÇ  ‚îú‚îÄ config/
   ‚îÇ  ‚îÇ  ‚îî‚îÄ env.js
   ‚îÇ  ‚îú‚îÄ middlewares/
   ‚îÇ  ‚îÇ  ‚îî‚îÄ error.middleware.js
   ‚îÇ  ‚îú‚îÄ models/
   ‚îÇ  ‚îÇ  ‚îú‚îÄ usuario.js
   ‚îÇ  ‚îÇ  ‚îú‚îÄ asignatura.js
   ‚îÇ  ‚îÇ  ‚îú‚îÄ seccion.js
   ‚îÇ  ‚îÇ  ‚îú‚îÄ bloquehorario.js
   ‚îÇ  ‚îÇ  ‚îî‚îÄ requisito.js
   ‚îÇ  ‚îú‚îÄ migrations/
   ‚îÇ  ‚îÇ  ‚îú‚îÄ (usuarios, asignaturas, secciones, bloques_horario, requisitos)
   ‚îÇ  ‚îú‚îÄ seeders/
   ‚îÇ  ‚îÇ  ‚îú‚îÄ 20251010013742-demo-usuarios.js
   ‚îÇ  ‚îÇ  ‚îú‚îÄ 20251013-01-seed-asignaturas.js
   ‚îÇ  ‚îÇ  ‚îú‚îÄ 20251013-02-seed-secciones.js
   ‚îÇ  ‚îÇ  ‚îú‚îÄ 20251013-03-seed-bloques.js
   ‚îÇ  ‚îÇ  ‚îî‚îÄ 20251013-04-seed-requisitos.js
   ‚îÇ  ‚îî‚îÄ routes/
   ‚îÇ     ‚îî‚îÄ v1/
   ‚îÇ        ‚îú‚îÄ health.routes.js
   ‚îÇ        ‚îú‚îÄ users.routes.js
   ‚îÇ        ‚îú‚îÄ asignaturas.routes.js
   ‚îÇ        ‚îú‚îÄ secciones.routes.js
   ‚îÇ        ‚îú‚îÄ bloques.routes.js
   ‚îÇ        ‚îî‚îÄ requisitos.routes.js
   ‚îî‚îÄ package.json
```

---

## ‚úÖ Requisitos

- **Node.js 18+** y npm
- **PostgreSQL** (puerto 5432)
- **Insomnia** o Postman para pruebas

---

## üîê Variables de entorno (`.env` en `jpix-backend/`)

```
NODE_ENV=development
PORT=3000

DB_HOST=127.0.0.1
DB_PORT=5432
DB_USER=jpix_user
DB_PASS=admin123
DB_NAME=jpix_db
DB_DIALECT=postgres
```

> No subir `.env` al repo. Mantener un `.env.example`.

---

## üß∞ Instalaci√≥n y scripts

```bash
# instalar deps
npm i
# deps clave
npm i express cors morgan
npm i sequelize pg pg-hstore
npm i bcryptjs csv-parse
npm i -D sequelize-cli dotenv nodemon

# scripts (package.json)
#  "dev": "nodemon src/server.js"
#  "db:create": "sequelize-cli db:create"
#  "db:migrate": "sequelize-cli db:migrate"
#  "db:seed": "sequelize-cli db:seed:all"
#  "db:reset": "sequelize-cli db:seed:undo:all && sequelize-cli db:migrate:undo:all && sequelize-cli db:migrate && sequelize-cli db:seed:all"
```

---

## üß± Modelos (resumen de campos y relaciones)

- **Usuario** (`usuarios`): `rut` (unique), `nombre`, `email` (unique), `password_hash`, `rol` (`admin|estudiante`).
- **Asignatura** (`asignaturas`): `sigla` (unique), `nombre`, `tipo` (`obligatoria|fofu|ingles|optativa`), `creditos`, `periodo_malla`, `semestralidad` (`ANUAL|SEMESTRAL`), `tasa_aprobacion`, `tasa_aprobacion_pct`.
  - Relaciones: `Asignatura.hasMany(Seccion, { as: 'secciones' })` y **self-join** v√≠a `Requisito` (`belongsToMany`).
- **Seccion** (`secciones`): `asignatura_id` (FK), `seccion`, `nombre`, `codigo_completo`, `docente`.
  - Relaciones: `belongsTo(Asignatura)` y `hasMany(BloqueHorario, { as: 'bloques' })`.
- **BloqueHorario** (`bloques_horario`): `seccion_id` (FK), `dia` (`LUN|MAR|MIE|JUE|VIE|SAB`), `clave_ini`, `clave_fin`, `actividad` (`CAT|TAL|AY`), `sede`, `sala`, `paridad` (`PAR|IMPAR|AMBOS`), `hora_inicio`, `hora_fin`.
  - Relaciones: `belongsTo(Seccion)`.
- **Requisito** (`requisitos`): `asignatura_id` (FK a asignaturas), `requiere_id` (FK a asignaturas).

> Las migraciones respetan el orden de dependencias: **asignaturas ‚Üí secciones ‚Üí bloques_horario ‚Üí requisitos**.

---

## üß™ Migraciones y seeders

```bash
npm run db:create
npm run db:migrate
npm run db:seed
```

### Semillas idempotentes (recomendado)
Para evitar errores de duplicados (ej. `usuarios_rut_key`), el seeder `demo-usuarios` borra los RUT a insertar antes de `bulkInsert`. Alternativa: *upsert* con `updateOnDuplicate` (no est√°ndar en `queryInterface`).

### Reset en dev
Si `db:reset` falla por dependencias (FKs), soluciones:
- **Down con CASCADE** en `dropTable('secciones', { cascade: true })`, o
- Deshacer primero `bloques_horario` y luego `secciones`, o
- `DROP TABLE "bloques_horario" CASCADE;` (solo dev).

---

## üöÄ Levantar servidor

```bash
npm run dev
# http://localhost:3000
```

Healthcheck:
```
GET /api/v1/health  ‚Üí  { "status": "ok" }
```

---

## üåê Endpoints (EP 2.3)

### Usuarios
```
GET    /api/v1/usuarios
GET    /api/v1/usuarios/:id
POST   /api/v1/usuarios
PUT    /api/v1/usuarios/:id
DELETE /api/v1/usuarios/:id
```
**POST /api/v1/usuarios (JSON):**
```json
{
  "rut":"12345678-9",
  "nombre":"Nuevo",
  "email":"nuevo@jpix.cl",
  "password":"secreto",
  "rol":"estudiante"
}
```

---

### Asignaturas
```
GET  /api/v1/asignaturas
GET  /api/v1/asignaturas/:sigla   # incluye secciones y bloques
```
**Ejemplo:**
```
GET /api/v1/asignaturas/INF1211
‚Üí { "data": { "sigla":"INF1211", "nombre":"...", "secciones":[{ "bloques":[...] }] } }
```

---

### Secciones
```
GET  /api/v1/secciones
GET  /api/v1/secciones/:id
```
> (CRUD completo opcional; hoy se exponen consultas de lectura para apoyar la vista y depuraci√≥n)

---

### Bloques Horario
```
GET  /api/v1/bloques
GET  /api/v1/bloques/:id
```

---

### Requisitos
```
GET  /api/v1/requisitos
GET  /api/v1/requisitos/:id
```

---

## üß™ Gu√≠a de pruebas con **Insomnia**

1. **Crear entorno** con variable `base_url = http://localhost:3000/api/v1`.
2. **Colecci√≥n** ‚ÄúJpix / v1‚Äù con requests:
   - `GET {{ base_url }}/health`
   - `GET {{ base_url }}/usuarios`
   - `POST {{ base_url }}/usuarios` (body JSON del ejemplo)
   - `PUT {{ base_url }}/usuarios/:id` (cambiar `nombre`, `email` o `password` ‚Üí se hashea)
   - `DELETE {{ base_url }}/usuarios/:id`
   - `GET {{ base_url }}/asignaturas`
   - `GET {{ base_url }}/asignaturas/INF1211`
   - `GET {{ base_url }}/secciones`
   - `GET {{ base_url }}/secciones/1`
   - `GET {{ base_url }}/bloques`
   - `GET {{ base_url }}/bloques/1`
   - `GET {{ base_url }}/requisitos`
   - `GET {{ base_url }}/requisitos/1`
3. Verificar respuestas `200/201/204` y formato `{ "data": ... }` o `{ "error": { message, code } }`.

---

## üõ°Ô∏è Manejo de errores y formato de respuesta

- **OK** ‚Üí `{ "data": ... }`
- **Error** ‚Üí `{ "error": { "message": "...", "code": 400|401|403|404|409|500 } }`
- Middleware global: `errorHandler`, 404 gen√©rico y `favicon.ico` silencioso.

---

## üîú Preparado para EP 2.4 (no implementado aqu√≠)

- Front **Ionic** consumir√° esta API con `HttpClient`.
- Configurar `environment.ts`: `API_URL = 'http://localhost:3000/api/v1'`.
- Servicios recomendados: `AsignaturasService`, `UsuariosService`, etc.

---

## üß© Troubleshooting real

- **"llave duplicada viola restricci√≥n de unicidad 'usuarios_rut_key'"**
  - Soluci√≥n: `seed:undo` del seeder, o seeder idempotente (delete+insert), o `db:reset`.
- **"no existe la relaci√≥n ¬´asignaturas¬ª"**
  - Causa: migraciones no aplicadas / orden incorrecto.
  - Soluci√≥n: `npx sequelize-cli db:migrate`, verificar con `\dt` en psql.
- **Undo con FKs (secciones/bloques)**
  - Soluci√≥n: `dropTable('secciones', { cascade: true })` en `down`, o deshacer en orden.

---

## ‚úÖ Estado EP 2.3

- ‚úÖ Backend Express operativo con prefijo **`/api/v1`**
- ‚úÖ Modelos Sequelize y relaciones
- ‚úÖ Migraciones y seeders aplicados
- ‚úÖ Endpoints listos y probados con **Insomnia**
- üöß Listo para **EP 2.4** (consumo desde Ionic)

---

Hecho con ‚ù§Ô∏è para Jpix.